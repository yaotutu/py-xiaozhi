# ğŸ” è®¾å¤‡æ¿€æ´»æµç¨‹è¯´æ˜

## ğŸŒŸ æ¦‚è¿°

py-xiaozhié¡¹ç›®æ”¯æŒv1å’Œv2ä¸¤ç§è®¾å¤‡æ¿€æ´»åè®®ï¼Œä¸ºå®¢æˆ·ç«¯è®¾å¤‡æä¾›å®‰å…¨å¯é çš„èº«ä»½éªŒè¯æœºåˆ¶ã€‚å½“å‰ç³»ç»Ÿé»˜è®¤ä½¿ç”¨v2ç‰ˆæœ¬æ¿€æ´»æµç¨‹ï¼Œè¯¥ç‰ˆæœ¬é‡‡ç”¨åºåˆ—å·ã€HMACç­¾åå’ŒéªŒè¯ç ä¸‰é‡éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿è®¾å¤‡æ¿€æ´»çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚

### ğŸ¯ æ¿€æ´»ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | v1ç‰ˆæœ¬ | v2ç‰ˆæœ¬ (æ¨è) |
|------|--------|---------------|
| **éªŒè¯æ–¹å¼** | ç®€åŒ–éªŒè¯ | åºåˆ—å· + HMAC + éªŒè¯ç  |
| **å®‰å…¨ç­‰çº§** | åŸºç¡€ | é«˜çº§ |
| **ç”¨æˆ·äº¤äº’** | æ— éœ€éªŒè¯ç  | éœ€è¦ç½‘é¡µè¾“å…¥éªŒè¯ç  |
| **è®¾å¤‡è¯†åˆ«** | MACåœ°å€ | åºåˆ—å· + MACåœ°å€ |
| **é€‚ç”¨åœºæ™¯** | å¼€å‘æµ‹è¯• | ç”Ÿäº§ç¯å¢ƒ |

### ğŸ”§ é…ç½®æ–¹å¼

åœ¨ `config/config.json` ä¸­è®¾ç½®æ¿€æ´»ç‰ˆæœ¬ï¼š

```json
{
  "SYSTEM_OPTIONS": {
    "NETWORK": {
      "ACTIVATION_VERSION": "v2",  // å¯é€‰å€¼: "v1", "v2"
      "AUTHORIZATION_URL": "https://xiaozhi.me/"
    }
  }
}
```

## ğŸ”„ æ¿€æ´»æµç¨‹è¯¦è§£

### ğŸ“‹ v2ç‰ˆæœ¬æ¿€æ´»æ­¥éª¤

æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·(Serial Number)å’ŒHMACå¯†é’¥(HMAC Key)ï¼Œç”¨äºèº«ä»½éªŒè¯å’Œå®‰å…¨é€šä¿¡ã€‚æ–°è®¾å¤‡é¦–æ¬¡ä½¿ç”¨æ—¶éœ€è¦é€šè¿‡ä»¥ä¸‹æµç¨‹è¿›è¡Œæ¿€æ´»ï¼š

#### 1ï¸âƒ£ è®¾å¤‡åˆå§‹åŒ–é˜¶æ®µ
- å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œç”Ÿæˆæˆ–è¯»å–è®¾å¤‡èº«ä»½ä¿¡æ¯
- å‘OTAæœåŠ¡å™¨å‘é€è®¾å¤‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
  - åºåˆ—å· (Serial Number)  
  - MACåœ°å€ (Device ID)
  - å®¢æˆ·ç«¯UUID (Client ID)
  - è®¾å¤‡ç¡¬ä»¶ä¿¡æ¯

#### 2ï¸âƒ£ æœåŠ¡å™¨éªŒè¯é˜¶æ®µ  
æœåŠ¡å™¨æ£€æŸ¥è®¾å¤‡æ¿€æ´»çŠ¶æ€ï¼š
- âœ… **å·²æ¿€æ´»**: è¿”å›è¿æ¥é…ç½®ï¼Œå®¢æˆ·ç«¯æ­£å¸¸å·¥ä½œ
- â³ **æœªæ¿€æ´»**: è¿”å›æ¿€æ´»è¯·æ±‚ï¼ŒåŒ…å«éªŒè¯ç å’ŒChallenge

#### 3ï¸âƒ£ ç”¨æˆ·éªŒè¯é˜¶æ®µ
- å®¢æˆ·ç«¯æ˜¾ç¤ºéªŒè¯ç ï¼Œæç¤ºç”¨æˆ·å‰å¾€ xiaozhi.me ç½‘ç«™
- ç”¨æˆ·åœ¨ç½‘é¡µç«¯è¾“å…¥éªŒè¯ç è¿›è¡ŒéªŒè¯
- å®¢æˆ·ç«¯ä½¿ç”¨HMACå¯†é’¥å¯¹Challengeè¿›è¡Œç­¾å

#### 4ï¸âƒ£ è½®è¯¢ç¡®è®¤é˜¶æ®µ
- å®¢æˆ·ç«¯å‘é€HMACç­¾ååˆ°æœåŠ¡å™¨è¿›è¡ŒéªŒè¯
- é€šè¿‡HTTP Long Pollingç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ï¼š
  - ğŸ‰ **éªŒè¯æˆåŠŸ**: è®¾å¤‡æ¿€æ´»å®Œæˆï¼Œè·å¾—è¿æ¥é…ç½®
  - âŒ **éªŒè¯å¤±è´¥**: æ¿€æ´»å¤±è´¥ï¼Œéœ€è¦é‡æ–°å°è¯•
  - â° **è¶…æ—¶**: é‡æ–°è·å–éªŒè¯ç 

### ğŸš€ è·³è¿‡æ¿€æ´»æ¨¡å¼

å¯¹äºå¼€å‘è°ƒè¯•åœºæ™¯ï¼Œç³»ç»Ÿæä¾›è·³è¿‡æ¿€æ´»çš„é€‰é¡¹ï¼š

```bash
# è·³è¿‡è®¾å¤‡æ¿€æ´»ç›´æ¥è¿è¡Œ
python main.py --skip-activation

# CLIæ¨¡å¼è·³è¿‡æ¿€æ´»
python main.py --mode cli --skip-activation
```

> **æ³¨æ„**: è·³è¿‡æ¿€æ´»æ¨¡å¼ä»…é€‚ç”¨äºå¼€å‘æµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å®Œæ•´æ¿€æ´»æµç¨‹ã€‚

## ğŸ“Š å®Œæ•´æ¿€æ´»æµç¨‹å›¾

### ğŸ”§ å®¢æˆ·ç«¯æ¿€æ´»æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è®¾å¤‡æ¿€æ´»å®Œæ•´æµç¨‹                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸš€ åº”ç”¨å¯åŠ¨                      ğŸ¯ æ¿€æ´»æˆåŠŸ
         â”‚                              â†‘
         â–¼                              â”‚
    ğŸ”§ è®¾å¤‡åˆå§‹åŒ–                   ğŸ“¡ è·å–è¿æ¥é…ç½®
    è¯»å–è®¾å¤‡èº«ä»½ä¿¡æ¯                WebSocket/MQTT
         â”‚                              â”‚
         â–¼                              â”‚
    ğŸ“‹ æ£€æŸ¥æ¿€æ´»çŠ¶æ€                  âœ… HMACéªŒè¯é€šè¿‡
    å‘OTAæœåŠ¡å™¨æŸ¥è¯¢                      â”‚
         â”‚                              â”‚
         â–¼                              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           æœåŠ¡å™¨å“åº”               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                        â”‚
    â”‚ è®¾å¤‡çŠ¶æ€  â”‚                        â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â”‚
         â”‚                              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   å·²æ¿€æ´»     â”‚              â”‚     æœªæ¿€æ´»        â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â–¼                              â–¼
  ğŸ“¡ ç›´æ¥è¿æ¥æœåŠ¡               ğŸ” å¼€å§‹æ¿€æ´»æµç¨‹
         â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
                        â”‚               â–¼
                        â”‚    ğŸ“± æ˜¾ç¤ºéªŒè¯ç ç•Œé¢
                        â”‚    "è¯·å‰å¾€ xiaozhi.me"
                        â”‚               â”‚
                        â”‚               â–¼
                        â”‚    ğŸ”’ è®¡ç®—HMACç­¾å
                        â”‚    HMAC(å¯†é’¥, Challenge)
                        â”‚               â”‚
                        â”‚               â–¼
                        â”‚    ğŸ“¡ å‘é€æ¿€æ´»è¯·æ±‚
                        â”‚    POST /xiaozhi/ota/activate
                        â”‚               â”‚
                        â”‚               â–¼
                        â”‚    â³ è½®è¯¢ç­‰å¾…éªŒè¯
                        â”‚    HTTP Long Polling
                        â”‚               â”‚
                        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    â”‚    æœåŠ¡å™¨å“åº”        â”‚
                        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚               â”‚
                        â”‚    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
                        â”‚    â”‚     â”‚         â”‚     â”‚
                        â”‚    â–¼     â–¼         â–¼     â–¼
                        â”‚  âœ…æˆåŠŸ  â°ç­‰å¾…   âŒå¤±è´¥  ğŸ”„è¶…æ—¶
                        â”‚    â”‚     â”‚         â”‚     â”‚
                        â”‚    â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
                        â”‚          â”‚         â”‚
                        â”‚          â–¼         â–¼
                        â”‚      â±ï¸å»¶è¿Ÿé‡è¯•  âš ï¸ æ¿€æ´»å¤±è´¥
                        â”‚          â”‚         â”‚
                        â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â–¼
                                    ğŸ‰ æ¿€æ´»å®Œæˆï¼Œå¼€å§‹å·¥ä½œ
```

### ğŸ‘¥ ç”¨æˆ·äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯è®¾å¤‡   â”‚                 â”‚    æœåŠ¡å™¨     â”‚                 â”‚  ç”¨æˆ·æµè§ˆå™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚                               â”‚
       â”‚ 1. è¯·æ±‚è®¾å¤‡çŠ¶æ€                 â”‚                               â”‚
       â”‚ POST /xiaozhi/ota/            â”‚                               â”‚
       â”‚ {mac, client_id, sn...}       â”‚                               â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                               â”‚
       â”‚                               â”‚                               â”‚
       â”‚ 2. è¿”å›æ¿€æ´»è¯·æ±‚                 â”‚                               â”‚
       â”‚ {code: "123456", challenge}   â”‚                               â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                               â”‚
       â”‚                               â”‚                               â”‚
       â”‚ 3. æ˜¾ç¤ºéªŒè¯ç                    â”‚                               â”‚
       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                               â”‚
       â”‚ â”‚ è¯·å‰å¾€ xiaozhi.me       â”‚   â”‚                               â”‚
       â”‚ â”‚ è¾“å…¥éªŒè¯ç : 123456      â”‚   â”‚                               â”‚
       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                               â”‚
       â”‚                               â”‚                               â”‚
       â”‚                               â”‚ 4. ç”¨æˆ·è®¿é—®æ¿€æ´»é¡µé¢              â”‚
       â”‚                               â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
       â”‚                               â”‚                               â”‚
       â”‚                               â”‚ 5. è¾“å…¥éªŒè¯ç                    â”‚
       â”‚                               â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
       â”‚                               â”‚                               â”‚
       â”‚ 6. å‘é€HMACç­¾å                â”‚                               â”‚
       â”‚ POST /xiaozhi/ota/activate    â”‚                               â”‚
       â”‚ {sn, challenge, hmac}         â”‚                               â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                               â”‚
       â”‚                               â”‚                               â”‚
       â”‚ 7. è½®è¯¢ç­‰å¾…éªŒè¯                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ â”‚ ç­‰å¾…ç”¨æˆ·å®ŒæˆéªŒè¯           â”‚    â”‚
       â”‚ HTTP 202 (Pending)            â”‚ â”‚ è¶…æ—¶è¿”å› 202              â”‚    â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                               â”‚                               â”‚
       â”‚ 8. ç»§ç»­è½®è¯¢...                  â”‚                               â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                               â”‚
       â”‚                               â”‚                               â”‚
       â”‚                               â”‚ 9. éªŒè¯ç éªŒè¯å®Œæˆ                â”‚
       â”‚                               â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                               â”‚                               â”‚
       â”‚ 10. æ¿€æ´»æˆåŠŸ                   â”‚                               â”‚
       â”‚ HTTP 200 + è¿æ¥é…ç½®            â”‚                               â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                               â”‚
       â”‚                               â”‚                               â”‚
       â”‚ 11. å¼€å§‹æ­£å¸¸å·¥ä½œ                â”‚                               â”‚
       â”‚ WebSocket/MQTT è¿æ¥           â”‚                               â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                               â”‚
```

## ğŸ“¡ APIé€šä¿¡åè®®è¯¦è§£

### ğŸ” 1. è®¾å¤‡çŠ¶æ€æŸ¥è¯¢ (POST /xiaozhi/ota/)

#### è¯·æ±‚å¤´ä¿¡æ¯
```http
POST /xiaozhi/ota/ HTTP/1.1
Activation-Version: 2
Device-Id: AA:BB:CC:DD:EE:FF
Client-Id: 12345678-1234-1234-1234-123456789012
User-Agent: py-xiaozhi/1.0.0
Content-Type: application/json
```

#### è¯·æ±‚ä½“ (Pythonå®¢æˆ·ç«¯)
```json
{
  "version": 2,
  "platform": "python",
  "client_info": {
    "mac_address": "AA:BB:CC:DD:EE:FF",
    "client_id": "12345678-1234-1234-1234-123456789012",
    "serial_number": "SN-ABC123-DEF456"
  },
  "system_info": {
    "os": "Windows 10",
    "python_version": "3.10.8",
    "architecture": "x86_64"
  },
  "application": {
    "name": "py-xiaozhi",
    "version": "1.0.0",
    "build_time": "2024-01-01T12:00:00Z"
  }
}
```

### ğŸ“ 2. æœåŠ¡å™¨å“åº”æ ¼å¼

#### æ¿€æ´»æˆåŠŸå“åº” (HTTP 200)
```json
{
  "status": "activated",
  "websocket": {
    "url": "wss://api.tenclass.net/xiaozhi/v1/",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "mqtt": {
    "endpoint": "mqtt.xiaozhi.me",
    "port": 1883,
    "client_id": "GID_test@@@AA_BB_CC_DD_EE_FF@@@client-uuid",
    "username": "base64_encoded_username",
    "password": "encrypted_password",
    "publish_topic": "device-server",
    "subscribe_topic": "server-device"
  },
  "configuration": {
    "heartbeat_interval": 30,
    "retry_attempts": 3,
    "timeout_ms": 10000
  }
}
```

#### éœ€è¦æ¿€æ´»å“åº” (HTTP 202)
```json
{
  "status": "need_activation",
  "activation": {
    "message": "è¯·è®¿é—® xiaozhi.me è¾“å…¥æ¿€æ´»ç ",
    "code": "123456",
    "challenge": "dac852d6-4ac4-4650-ba1a-c2a5bf00a766",
    "timeout_ms": 300000,
    "activation_url": "https://xiaozhi.me/activate"
  },
  "firmware": {
    "current_version": "1.0.0",
    "latest_version": "1.0.1",
    "update_required": false
  }
}
```

### ğŸ” 3. è®¾å¤‡æ¿€æ´»è¯·æ±‚ (POST /xiaozhi/ota/activate)

#### è¯·æ±‚å¤´ä¿¡æ¯
```http
POST /xiaozhi/ota/activate HTTP/1.1
Activation-Version: 2
Device-Id: AA:BB:CC:DD:EE:FF
Client-Id: 12345678-1234-1234-1234-123456789012
Content-Type: application/json
```

#### è¯·æ±‚ä½“
```json
{
  "Payload": {
    "algorithm": "hmac-sha256",
    "serial_number": "SN-ABC123-DEF456",
    "challenge": "dac852d6-4ac4-4650-ba1a-c2a5bf00a766",
    "hmac": "ada4775e3ed93cf9c0eb9ed00444138554ba416af41283a0e5603c77681a8022"
  }
}
```

### ğŸ“Š 4. æ¿€æ´»å“åº”çŠ¶æ€ç 

| çŠ¶æ€ç  | å«ä¹‰ | è¯´æ˜ |
|--------|------|------|
| **200** | æ¿€æ´»æˆåŠŸ | è¿”å›å®Œæ•´è¿æ¥é…ç½® |
| **202** | ç­‰å¾…éªŒè¯ | ç”¨æˆ·å°šæœªè¾“å…¥éªŒè¯ç  |
| **400** | è¯·æ±‚é”™è¯¯ | å‚æ•°æ ¼å¼é”™è¯¯æˆ–ç¼ºå¤± |
| **401** | éªŒè¯å¤±è´¥ | HMACç­¾åéªŒè¯å¤±è´¥ |
| **403** | è®¾å¤‡ç¦ç”¨ | è®¾å¤‡è¢«ç®¡ç†å‘˜ç¦ç”¨ |
| **404** | è®¾å¤‡ä¸å­˜åœ¨ | åºåˆ—å·ä¸å­˜åœ¨ |
| **409** | å†²çªçŠ¶æ€ | è®¾å¤‡å·²è¢«å…¶ä»–å®¢æˆ·ç«¯æ¿€æ´» |
| **429** | è¯·æ±‚è¿‡é¢‘ | æ¿€æ´»è¯·æ±‚è¿‡äºé¢‘ç¹ |
| **500** | æœåŠ¡å™¨é”™è¯¯ | å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ |

#### å¤±è´¥å“åº”ç¤ºä¾‹
```json
{
  "error": {
    "code": "INVALID_HMAC",
    "message": "HMACç­¾åéªŒè¯å¤±è´¥",
    "details": "æä¾›çš„HMACç­¾åä¸æœåŠ¡å™¨è®¡ç®—ç»“æœä¸åŒ¹é…"
  },
  "retry_after": 5000  // æ¯«ç§’åå¯é‡è¯•
}
```


## ğŸ”’ å®‰å…¨æœºåˆ¶è¯¦è§£

è®¾å¤‡æ¿€æ´»æµç¨‹v2ç‰ˆæœ¬é‡‡ç”¨å¤šå±‚å®‰å…¨éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§ï¼š

### ğŸ›¡ï¸ æ ¸å¿ƒå®‰å…¨ç‰¹æ€§

#### 1. **è®¾å¤‡å”¯ä¸€æ ‡è¯†**
- **åºåˆ—å·**: æ¯ä¸ªè®¾å¤‡å…·æœ‰å…¨çƒå”¯ä¸€çš„åºåˆ—å· (Serial Number)
- **MACåœ°å€**: ç½‘ç»œæ¥å£ç‰©ç†åœ°å€ä½œä¸ºè®¾å¤‡ç¡¬ä»¶æ ‡è¯†  
- **å®¢æˆ·ç«¯UUID**: è½¯ä»¶å±‚é¢çš„å”¯ä¸€æ ‡è¯†ç¬¦
- **è®¾å¤‡æŒ‡çº¹**: åŒ…å«ç¡¬ä»¶é…ç½®ã€ç³»ç»Ÿä¿¡æ¯ç­‰çš„å¤åˆæ ‡è¯†

#### 2. **HMACæ•°å­—ç­¾å**
- **ç®—æ³•**: ä½¿ç”¨ HMAC-SHA256 ç®—æ³•ç¡®ä¿æ•°æ®å®Œæ•´æ€§
- **å¯†é’¥ç®¡ç†**: æ¯ä¸ªè®¾å¤‡é¢„ç½®å”¯ä¸€çš„HMACå¯†é’¥
- **Challengeæœºåˆ¶**: æœåŠ¡å™¨æä¾›éšæœºChallengeï¼Œå®¢æˆ·ç«¯è®¡ç®—ç­¾å
- **é˜²é‡æ”¾**: æ¯æ¬¡æ¿€æ´»ä½¿ç”¨ä¸åŒçš„Challengeå€¼

```python
# HMACç­¾åè®¡ç®—ç¤ºä¾‹
import hmac
import hashlib

def calculate_hmac(secret_key: str, challenge: str) -> str:
    """è®¡ç®—HMAC-SHA256ç­¾å"""
    return hmac.new(
        secret_key.encode('utf-8'),
        challenge.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
```

#### 3. **è½®è¯¢ç­‰å¾…æœºåˆ¶**
- **HTTP Long Polling**: ä¼˜åŒ–ç½‘ç»œèµ„æºä½¿ç”¨
- **è¶…æ—¶æ§åˆ¶**: é¿å…æ— é™ç­‰å¾…
- **é‡è¯•ç­–ç•¥**: æŒ‡æ•°é€€é¿ç®—æ³•å¤„ç†ç½‘ç»œå¼‚å¸¸
- **çŠ¶æ€åŒæ­¥**: å®æ—¶åæ˜ æ¿€æ´»è¿›åº¦

## ğŸ› ï¸ æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§æ¿€æ´»é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### **ç½‘ç»œè¿æ¥é—®é¢˜**
```bash
è§£å†³æ­¥éª¤:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
2. éªŒè¯é˜²ç«å¢™è®¾ç½®
3. æµ‹è¯•DNSè§£æ
4. æ£€æŸ¥ä»£ç†é…ç½®
```

### ğŸ“ è°ƒè¯•å·¥å…·

#### æ¿€æ´»çŠ¶æ€æ£€æŸ¥
```bash
# æ£€æŸ¥è®¾å¤‡èº«ä»½æ–‡ä»¶
cat config/efuse.json

# æµ‹è¯•ç½‘ç»œè¿æ¥
curl -I https://api.tenclass.net/xiaozhi/ota/

# éªŒè¯è¯ä¹¦
openssl s_client -connect api.tenclass.net:443
```

#### æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹æ¿€æ´»ç›¸å…³æ—¥å¿—
grep "activation" logs/application.log

# æŸ¥çœ‹ç½‘ç»œè¯·æ±‚æ—¥å¿—
grep "OTA" logs/application.log
```
